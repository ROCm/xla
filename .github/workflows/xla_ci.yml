name: OpenXLA Internal CI

on:
  pull_request:
    branches:
      - 'rocm-jaxlib-v0.7.1'
      - 'leo*'
  workflow_dispatch:

env:
  # Default image
  IMAGE_NAME: "rocm/tensorflow-build@sha256:7cd444ac48657fee2f5087fbda7766266704d3f8fb2299f681952ae4eabed060"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate test matrix
        id: set-matrix
        run: |
          if [[ "${{ github.base_ref }}" == *0.5.0* ]]; then
            MODES='["default"]'
          else
            MODES='["default", "asan", "tsan"]'
          fi

          PLATFORMS='["gfx90a", "alpha2&&gfx90a"]'
          MATRIX_JSON='{"include":[]}'

          for PLATFORM in $(echo $PLATFORMS | jq -r '.[]'); do
            for MODE in $(echo $MODES | jq -r '.[]'); do
              PLATFORM_NAME=$([[ "$PLATFORM" == "alpha2&&gfx90a" ]] && echo "multigpu" || echo "gfx90a")
              MODE_NAME=$([[ "$MODE" == "default" ]] && echo "regular" || echo "$MODE")
              
              # Set runner label based on platform, as requested
              RUNNER_LABEL=$([[ "$PLATFORM_NAME" == "multigpu" ]] && echo "linux-mi355-4" || echo "linux-mi325-2")

              ENTRY=$(jq -n \
                              --arg p "$PLATFORM" \
                              --arg m "$MODE" \
                              --arg pn "$PLATFORM_NAME" \
                              --arg mn "$MODE_NAME" \
                              --arg rl "$RUNNER_LABEL" \
                              '{platform: $p, mode: $m, platform_name: $pn, mode_name: $mn, runner: $rl}')
              
              MATRIX_JSON=$(echo $MATRIX_JSON | jq ".include += [$ENTRY]")
            done
          done
          
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Generated Matrix: $MATRIX_JSON"

  jax-ut:
    name: jax-ut
    # Runs only on PRs to branches containing '0.7.1'
    if: contains(github.base_ref, '0.7.1')
    # This is always multigpu test, so it runs on the multigpu runner
    runs-on: linux-mi355-4
    timeout-minutes: 720 # 12 hours

    steps:
      - &step-cleanup-node
        name: Clean up node (pre-run)
        run: |
          echo "Cleaning up Docker resources..."
          docker system prune -af || true
          echo "Cleaning up workspace..."
          sudo rm -rf "${{ github.workspace }}"/*
          sudo rm -rf "${{ github.workspace }}"/.* || true

      - &step-clone-xla # Define anchor
        name: Clone ROCm/xla (project) SCM
        uses: actions/checkout@v4
        with:
          path: xla
          
      - name: Clone ROCm/jax
        uses: actions/checkout@v4
        with:
          repository: ROCm/jax
          ref: ${{ github.base_ref }} # Uses the PR target branch
          path: jax

      - name: Run XLA docker container
        id: docker_run
        run: |
          docker pull ${{ env.IMAGE_NAME }}
          
          ARTIFACTS_DIR="tensorflow_pkg"
          mkdir -p $ARTIFACTS_DIR
          
          # Note: This docker run is specific to jax-ut (includes /jax volume)
          CONTAINER_ID=$(docker run \
                -w /tf/xla -it -d --network=host \
                --gpus all \
                --ipc=host --shm-size 64G --group-add video \
                --cap-add=SYS_PTRACE --security-opt seccomp=unconfined \
                -v "${{ github.workspace }}/${ARTIFACTS_DIR}:/tf/pkg" \
                -v "${{ github.workspace }}/xla:/tf/xla" \
                -v "${{ github.workspace }}/jax:/tf/jax" \
                -v "/tmp/bazel_disk_cache:/tf/disk_cache_jax" \
                ${{ env.IMAGE_NAME }})
          
          echo "container_id=$CONTAINER_ID" >> $GITHUB_OUTPUT

      - name: Run jax unit-tests
        id: run_tests
        continue-on-error: true
        run: |
          # Replicates openxlaUtils.getJaxTestCommand
          docker exec -w /tf/xla ${{ steps.docker_run.outputs.container_id }} \
            ./build_tools/rocm/run_jax_ut.sh /tf/jax

      - name: Collect Logs on Failure
        if: steps.run_tests.outcome == 'failure'
        run: |
          # Replicates openxlaUtils.collectCacheLogs
          echo "Collecting cache logs..."
          mv cache cache_logs_multigpu
          sudo rm -rf cache_logs_multigpu/bazel/_bazel_root/*/command.log
          sudo apt-get install -y zip
          cd cache_logs_multigpu && zip -r ../cache_logs_multigpu.zip . -i *.log > /dev/null

      - name: Upload Logs Artifact
        if: steps.run_tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: cache_logs_multigpu
          path: cache_logs_multigpu.zip
          retention-days: 7

      - &step-final-cleanup # Define anchor
        name: Final Cleanup
        if: always()
        run: |
          if [ ! -z "${{ steps.docker_run.outputs.container_id }}" ]; then
            echo "Stopping and removing container..."
            docker stop ${{ steps.docker_run.outputs.container_id }}
            docker rm ${{ steps.docker_run.outputs.container_id }}
          fi
          echo "Cleaning up workspace..."
          sudo rm -rf "${{ github.workspace }}"/*
          sudo rm -rf "${{ github.workspace }}"/.* || true

  # Job for the main test matrix
  xla-tests:
    name: Test ${{ matrix.platform_name }} arch (${{ matrix.mode_name }})
    needs: setup
    # Use the runner label generated by the setup job
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 720
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - *step-cleanup-node # Reuse anchor

      - *step-clone-xla # Reuse anchor
        
      - name: Run XLA docker container
        id: docker_run
        run: |
          docker pull ${{ env.IMAGE_NAME }}
          
          ARTIFACTS_DIR="tensorflow_pkg"
          mkdir -p $ARTIFACTS_DIR
          
          # Note: This docker run is specific to xla-tests (no /jax volume)
          CONTAINER_ID=$(docker run \
                -w /tf/xla -it -d --network=host \
                --gpus all \
                --ipc=host --shm-size 64G --group-add video \
                --cap-add=SYS_PTRACE --security-opt seccomp=unconfined \
                -v "${{ github.workspace }}/${ARTIFACTS_DIR}:/tf/pkg" \
                -v "${{ github.workspace }}/xla:/tf/xla" \
                -v "/tmp/bazel_disk_cache:/tf/disk_cache" \
                ${{ env.IMAGE_NAME }})
          
          echo "container_id=$CONTAINER_ID" >> $GITHUB_OUTPUT

      - name: Test ${{ matrix.platform_name }} arch (${{ matrix.mode_name }})
        id: run_tests
        continue-on-error: true
        run: |
          # Replicates openxlaUtils.getTestCommand
          # Use matrix context directly (bugfix)
          IS_MULTI_GPU=$([[ "${{ matrix.platform_name }}" == "multigpu" ]] && echo "true" || echo "false")
          MODE_ARG=$([[ "${{ matrix.mode }}" == "default" ]] && echo "" || echo "${{ matrix.mode }}")
          
          if [ "$IS_MULTI_GPU" = "true" ]; then
            SCRIPT_PATH="./build_tools/rocm/run_xla_multi_gpu.sh"
          else
            SCRIPT_PATH="./build_tools/rocm/run_xla.sh"
          fi
          
          docker exec ${{ steps.docker_run.outputs.container_id }} $SCRIPT_PATH $MODE_ARG --config=rocm_rbe

      - name: Collect Logs on Failure
        if: steps.run_tests.outcome == 'failure'
        run: |
          # Replicates openxlaUtils.collectCacheLogs
          echo "Collecting cache logs..."
          # Use matrix context directly (bugfix)
          PLATFORM_NAME_LOGS="${{ matrix.platform_name }}_${{ matrix.mode }}"
          mv cache "cache_logs_${PLATFORM_NAME_LOGS}"
          sudo rm -rf "cache_logs_${PLATFORM_NAME_LOGS}/bazel/_bazel_root/*/command.log"
          sudo apt-get install -y zip
          cd "cache_logs_${PLATFORM_NAME_LOGS}" && zip -r "../cache_logs_${PLATFORM_NAME_LOGS}.zip" . -i *.log > /dev/null

      - name: Upload Logs Artifact
        if: steps.run_tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: cache_logs_${{ matrix.platform_name }}_${{ matrix.mode_name }}
          # Use matrix context directly (bugfix)
          path: cache_logs_${{ matrix.platform_name }}_${{ matrix.mode }}.zip
          retention-days: 7

      - name: Run analyze-profile command
        continue-on-error: true
        run: |
          # Replicates openxlaUtils.getAnalyzeProfileCommand
          docker exec ${{ steps.docker_run.outputs.container_id }} bazel analyze-profile /tf/pkg/profile.json.gz

      - *step-final-cleanup # Reuse anchor